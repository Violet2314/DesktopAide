# 今日数据导出覆盖功能完成

## 🎉 功能完成！

已成功为"今日数据导出"功能实现同一天多次导出时自动覆盖旧数据的功能。

## 🔧 实现内容

### **1. 应用详细数据覆盖**
- **已有功能**：`exportAppUsageData`方法已经实现了覆盖功能
- **覆盖策略**：DELETE + CREATE（先删除同日期记录，再创建新记录）
- **工作状态**：✅ 正常工作

### **2. 工作模式会话数据覆盖**
- **新增功能**：为`exportWorkModeSessions`方法添加了覆盖功能
- **覆盖策略**：DELETE + CREATE（按日期和会话类型删除）
- **新增字段**：添加了日期字段和会话类型标识

## 📊 修改详情

### **工作模式会话记录结构**

#### **修改前**
```json
{
  "fields": {
    "总时长": 2.5,
    "专注时长": 1.8,
    "分心时长": 0.7,
    "效率得分": 0.72
  }
}
```

#### **修改后**
```json
{
  "fields": {
    "日期": 1721865600000,        // 新增：日期字段
    "总时长": 2.5,
    "专注时长": 1.8,
    "分心时长": 0.7,
    "效率得分": 0.72,
    "会话类型": "work_mode"       // 新增：会话类型标识
  }
}
```

### **覆盖逻辑实现**

#### **按日期分组处理**
```typescript
// 按日期分组会话数据
const sessionsByDate = new Map<string, WorkModeSession[]>()
sessions.forEach(session => {
  const sessionDate = new Date(session.startTime).toISOString().split('T')[0]
  if (!sessionsByDate.has(sessionDate)) {
    sessionsByDate.set(sessionDate, [])
  }
  sessionsByDate.get(sessionDate)!.push(session)
})

// 为每个日期处理会话数据
for (const [date, dateSessions] of sessionsByDate) {
  // 先删除该日期的现有工作模式会话记录
  await this.deleteWorkModeSessionsByDate(date)
  
  // 然后创建新记录
  // ...
}
```

#### **精确删除逻辑**
```typescript
private async deleteWorkModeSessionsByDate(date: string): Promise<void> {
  // 查询所有记录，在客户端筛选
  const recordsToDelete = []
  for (const item of response.data.data.items) {
    const recordDate = item.fields['日期']
    const sessionType = item.fields['会话类型']
    
    // 只删除指定日期的工作模式会话记录
    if (recordDate === dateTimestamp && sessionType === 'work_mode') {
      recordsToDelete.push(item.record_id)
    }
  }
  
  // 批量删除
  if (recordsToDelete.length > 0) {
    await this.axiosInstance.delete(...)
  }
}
```

## 🎯 覆盖效果

### **今日数据导出包含两部分**

#### **1. 应用详细数据**
- **第一次导出**：创建24条应用记录
- **第二次导出**：删除24条旧记录，创建新的应用记录
- **日志示例**：
```
Searching for existing records to delete with date: 2025-07-25 (timestamp: 1753401600000)
Found 24 existing records for date 2025-07-25, deleting...
Successfully deleted 24 existing records for date 2025-07-25
App records batch 1 inserted successfully: 26 records
```

#### **2. 工作模式会话数据**
- **第一次导出**：创建工作模式会话记录
- **第二次导出**：删除同日期的工作模式会话记录，创建新记录
- **日志示例**：
```
Processing work mode sessions for date: 2025-07-25 (3 sessions)
Found 2 existing work mode sessions for date 2025-07-25, deleting...
Successfully deleted 2 existing work mode sessions for date 2025-07-25
Work mode session batch for 2025-07-25 inserted successfully: 3 records
```

## ✅ 功能特点

### **1. 智能分类删除**
- **应用数据**：删除所有同日期的应用记录
- **会话数据**：只删除同日期的工作模式会话记录
- **汇总数据**：不受影响（由单独的导出功能处理）

### **2. 按日期分组处理**
- **多日期支持**：如果会话跨越多天，按日期分别处理
- **精确覆盖**：每个日期的数据独立覆盖
- **数据完整性**：确保每个日期的数据完整

### **3. 详细日志记录**
- **删除日志**：显示删除的记录数量和ID
- **创建日志**：显示创建的记录数量
- **错误处理**：删除失败不影响创建操作

## 🔍 使用方法

### **1. 正常导出**
1. 打开数据导出页面
2. 点击"导出今日数据"
3. 系统自动导出应用数据和工作模式会话数据

### **2. 重复导出（覆盖）**
1. 同一天内可以多次点击"导出今日数据"
2. 系统自动删除旧的应用数据和工作模式会话数据
3. 创建最新的数据记录

### **3. 日志监控**
打开浏览器开发者工具，观察控制台日志：
```
# 应用数据覆盖
Searching for existing records to delete with date: 2025-07-25
Found 24 existing records, deleting...
Successfully deleted 24 existing records
App records batch 1 inserted successfully: 26 records

# 工作模式会话覆盖
Processing work mode sessions for date: 2025-07-25 (3 sessions)
Found 2 existing work mode sessions, deleting...
Successfully deleted 2 existing work mode sessions
Work mode session batch inserted successfully: 3 records
```

## 📊 数据表结构

### **应用详细数据表**
| 字段 | 类型 | 说明 |
|------|------|------|
| 日期 | 时间戳 | 记录日期 |
| 应用名称 | 文本 | 应用名称 |
| 使用时长 | 数字 | 使用时长（小时） |
| 分类 | 文本 | 应用分类 |

### **汇总数据表（包含工作模式会话）**
| 字段 | 类型 | 说明 |
|------|------|------|
| 日期 | 时间戳 | 记录日期 |
| 总时长 | 数字 | 总时长（小时） |
| 专注时长 | 数字 | 专注时长（小时） |
| 分心时长 | 数字 | 分心时长（小时） |
| 效率得分 | 数字 | 效率得分（小数） |
| 会话类型 | 文本 | work_mode 或空 |

## 🚀 使用场景

### **1. 实时更新**
- 工作过程中多次导出最新的今日数据
- 工作模式会话结束后立即更新
- 应用使用情况变化后重新导出

### **2. 数据修正**
- 发现数据异常时重新导出覆盖
- 应用分类调整后更新数据
- 工作模式时间统计修正后重新导出

### **3. 定期备份**
- 每天结束时导出最终的今日数据
- 确保飞书表格中的数据是最新的
- 避免重复记录造成的数据混乱

## 📝 注意事项

### **1. 覆盖不可逆**
- 删除操作无法撤销
- 建议在重要操作前确认数据正确性
- 网络异常时可能导致部分数据丢失

### **2. 会话类型标识**
- 工作模式会话记录有`会话类型: "work_mode"`标识
- 普通汇总记录没有此字段或为空
- 删除时只删除工作模式会话记录

### **3. 多日期处理**
- 如果工作模式会话跨越多天，会按日期分别处理
- 每个日期的数据独立覆盖
- 不会影响其他日期的数据

## ✅ 功能清单

- [x] **应用数据覆盖**：删除同日期应用记录，创建新记录
- [x] **工作模式会话覆盖**：删除同日期工作模式会话，创建新记录
- [x] **按日期分组**：多日期数据分别处理
- [x] **精确删除**：基于日期和会话类型精确删除
- [x] **详细日志**：完整的操作日志记录
- [x] **错误处理**：删除失败不影响创建操作

## 🎊 完成状态

现在"今日数据导出"功能完全支持覆盖：

- ✅ **应用数据覆盖**：自动删除旧的应用记录
- ✅ **会话数据覆盖**：自动删除旧的工作模式会话记录
- ✅ **智能识别**：精确识别需要删除的记录
- ✅ **数据完整性**：确保每次导出的数据完整准确
- ✅ **操作简单**：用户无感知的自动处理

享受更加便捷和准确的今日数据导出体验！🚀
